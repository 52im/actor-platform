//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/actor-ios/build/java/im/actor/model/droidkit/actors/mailbox/collections/EnvelopeCollection.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/droidkit/actors/Environment.h"
#include "im/actor/model/droidkit/actors/mailbox/Envelope.h"
#include "im/actor/model/droidkit/actors/mailbox/collections/EnvelopeCollection.h"
#include "im/actor/model/droidkit/actors/mailbox/collections/EnvelopeRoot.h"
#include "im/actor/model/droidkit/actors/mailbox/collections/ScheduledEnvelope.h"
#include "im/actor/model/util/AtomicIntegerCompat.h"
#include "im/actor/model/util/ThreadLocalCompat.h"
#include "java/lang/Long.h"
#include "java/util/Collection.h"
#include "java/util/Iterator.h"
#include "java/util/Map.h"
#include "java/util/Set.h"
#include "java/util/TreeMap.h"

@interface ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection () {
 @public
  JavaUtilTreeMap *envelopes_;
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *root_;
  jint id__;
  jlong topKey_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection, envelopes_, JavaUtilTreeMap *)
J2OBJC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection, root_, ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *)

@interface ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult () {
 @public
  ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope__;
  jlong delay__;
}
- (instancetype)initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope;
- (instancetype)initWithLong:(jlong)delay;
@end

J2OBJC_FIELD_SETTER(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult, envelope__, ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)

BOOL ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_initialized = NO;

@implementation ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection

AMAtomicIntegerCompat * ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_NEXT_ID_;

- (instancetype)initWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot:(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *)root {
  if (self = [super init]) {
    envelopes_ = [[JavaUtilTreeMap alloc] init];
    self->id__ = [((AMAtomicIntegerCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_NEXT_ID_)) getAndIncrement];
    self->root_ = root;
    self->topKey_ = 0LL;
    [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(self->root_)) attachCollectionWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return self;
}

- (jint)getId {
  return id__;
}

- (jlong)getTopKey {
  return topKey_;
}

- (jlong)putEnvelopeWithDKEnvelope:(DKEnvelope *)envelope
                          withLong:(jlong)time {
  jlong key = [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) buildKeyWithLong:time];
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    (void) [((JavaUtilTreeMap *) nil_chk(envelopes_)) putWithId:JavaLangLong_valueOfWithLong_(key) withId:[[ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope alloc] initWithLong:key withLong:time withDKEnvelope:envelope]];
    if (key < topKey_ || topKey_ == 0) {
      topKey_ = key;
    }
  }
  if (oldKey != topKey_) {
    [root_ changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return key;
}

- (void)removeEnvelopeWithDKEnvelope:(DKEnvelope *)envelope
withImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator:(id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>)comparator {
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    id<JavaUtilIterator> iterator = [((id<JavaUtilSet>) nil_chk([((JavaUtilTreeMap *) nil_chk(envelopes_)) entrySet])) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iterator)) hasNext]) {
      if ([((id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>) nil_chk(comparator)) equalsWithDKEnvelope:[((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk([((id<JavaUtilMap_Entry>) nil_chk([iterator next])) getValue])) getEnvelope] withDKEnvelope:envelope]) {
        [iterator remove];
      }
    }
    if ([envelopes_ isEmpty]) {
      topKey_ = 0;
    }
    else {
      topKey_ = [((JavaLangLong *) nil_chk([envelopes_ firstKey])) longLongValue];
    }
  }
  if (oldKey != topKey_) {
    [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
}

- (jlong)putEnvelopeOnceWithDKEnvelope:(DKEnvelope *)envelope
                              withLong:(jlong)time
withImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator:(id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>)comparator {
  jlong key = [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) buildKeyWithLong:time];
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    id<JavaUtilIterator> iterator = [((id<JavaUtilSet>) nil_chk([((JavaUtilTreeMap *) nil_chk(envelopes_)) entrySet])) iterator];
    while ([((id<JavaUtilIterator>) nil_chk(iterator)) hasNext]) {
      if ([((id<ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator>) nil_chk(comparator)) equalsWithDKEnvelope:[((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk([((id<JavaUtilMap_Entry>) nil_chk([iterator next])) getValue])) getEnvelope] withDKEnvelope:envelope]) {
        [iterator remove];
      }
    }
    (void) [envelopes_ putWithId:JavaLangLong_valueOfWithLong_(key) withId:[[ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope alloc] initWithLong:key withLong:time withDKEnvelope:envelope]];
    topKey_ = [((JavaLangLong *) nil_chk([envelopes_ firstKey])) longLongValue];
  }
  if (oldKey != topKey_) {
    [root_ changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return key;
}

- (ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)fetchEnvelopeWithLong:(jlong)time {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *result;
  jlong oldKey;
  @synchronized(envelopes_) {
    oldKey = topKey_;
    if ([((JavaUtilTreeMap *) nil_chk(envelopes_)) isEmpty]) {
      return nil;
    }
    ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope = [((id<JavaUtilMap_Entry>) nil_chk([envelopes_ firstEntry])) getValue];
    if ([((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk(envelope)) getTime] <= time) {
      (void) [envelopes_ removeWithId:JavaLangLong_valueOfWithLong_([envelope getKey])];
      if ([envelopes_ isEmpty]) {
        topKey_ = 0;
      }
      else {
        topKey_ = [((JavaLangLong *) nil_chk([envelopes_ firstKey])) longLongValue];
      }
      result = ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(envelope);
    }
    else {
      result = ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_delayWithLong_([envelope getTime] - time);
    }
  }
  if (oldKey != topKey_) {
    [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
  }
  return result;
}

- (void)clear {
  @synchronized(envelopes_) {
    [((JavaUtilTreeMap *) nil_chk(envelopes_)) clear];
    topKey_ = 0;
  }
  [((ImActorModelDroidkitActorsMailboxCollectionsEnvelopeRoot *) nil_chk(root_)) changedTopKeyWithImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection:self];
}

- (jint)getSize {
  @synchronized(envelopes_) {
    return [((JavaUtilTreeMap *) nil_chk(envelopes_)) size];
  }
}

- (IOSObjectArray *)allEnvelopes {
  @synchronized(envelopes_) {
    IOSObjectArray *scheduledEnvelopes = [((id<JavaUtilCollection>) nil_chk([((JavaUtilTreeMap *) nil_chk(envelopes_)) values])) toArrayWithNSObjectArray:[IOSObjectArray newArrayWithLength:[envelopes_ size] type:ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_class_()]];
    IOSObjectArray *res = [IOSObjectArray newArrayWithLength:((IOSObjectArray *) nil_chk(scheduledEnvelopes))->size_ type:DKEnvelope_class_()];
    for (jint i = 0; i < res->size_; i++) {
      IOSObjectArray_Set(res, i, [((ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *) nil_chk(IOSObjectArray_Get(scheduledEnvelopes, i))) getEnvelope]);
    }
    return res;
  }
}

- (void)copyAllFieldsTo:(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection *)other {
  [super copyAllFieldsTo:other];
  other->envelopes_ = envelopes_;
  other->root_ = root_;
  other->id__ = id__;
  other->topKey_ = topKey_;
}

+ (void)initialize {
  if (self == [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection class]) {
    ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_NEXT_ID_ = DKEnvironment_createAtomicIntWithInt_(1);
    J2OBJC_SET_INITIALIZED(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection)
  }
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection)

J2OBJC_INTERFACE_TYPE_LITERAL_SOURCE(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_EnvelopeComparator)

BOOL ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_initialized = NO;

@implementation ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult

AMThreadLocalCompat * ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_;

+ (ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope {
  return ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(envelope);
}

+ (ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)delayWithLong:(jlong)delay {
  return ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_delayWithLong_(delay);
}

- (instancetype)initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope {
  if (self = [super init]) {
    self->envelope__ = envelope;
  }
  return self;
}

- (instancetype)initWithLong:(jlong)delay {
  if (self = [super init]) {
    self->delay__ = delay;
  }
  return self;
}

- (ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)getEnvelope {
  return envelope__;
}

- (jlong)getDelay {
  return delay__;
}

- (void)updateWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *)envelope
                                                                       withLong:(jlong)delay {
  self->envelope__ = envelope;
  self->delay__ = delay;
}

- (void)recycle {
  [((AMThreadLocalCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_)) setWithId:self];
}

- (void)copyAllFieldsTo:(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *)other {
  [super copyAllFieldsTo:other];
  other->envelope__ = envelope__;
  other->delay__ = delay__;
}

+ (void)initialize {
  if (self == [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult class]) {
    ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_ = DKEnvironment_createThreadLocal();
    J2OBJC_SET_INITIALIZED(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult)
  }
}

@end

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_envelopeWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope_(ImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope *envelope) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_init();
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *res = [((AMThreadLocalCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_)) get];
  if (res != nil) {
    [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_ remove];
    [res updateWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:envelope withLong:0];
  }
  else {
    res = [[ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult alloc] initWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:envelope];
  }
  return res;
}

ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_delayWithLong_(jlong delay) {
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_init();
  ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult *res = [((AMThreadLocalCompat *) nil_chk(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_)) get];
  if (res != nil) {
    [ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult_RESULT_CACHE_ remove];
    [res updateWithImActorModelDroidkitActorsMailboxCollectionsScheduledEnvelope:nil withLong:delay];
  }
  else {
    res = [[ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult alloc] initWithLong:delay];
  }
  return res;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelDroidkitActorsMailboxCollectionsEnvelopeCollection_FetchResult)
