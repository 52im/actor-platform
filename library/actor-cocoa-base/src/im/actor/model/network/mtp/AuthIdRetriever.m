//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/network/mtp/AuthIdRetriever.java
//

#line 1 "/Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/network/mtp/AuthIdRetriever.java"

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/NetworkProvider.h"
#include "im/actor/model/droidkit/bser/DataInput.h"
#include "im/actor/model/droidkit/bser/DataOutput.h"
#include "im/actor/model/log/Log.h"
#include "im/actor/model/network/ActorApi.h"
#include "im/actor/model/network/Connection.h"
#include "im/actor/model/network/ConnectionEndpoint.h"
#include "im/actor/model/network/Endpoints.h"
#include "im/actor/model/network/mtp/AuthIdRetriever.h"
#include "im/actor/model/util/ExponentialBackoff.h"
#include "java/lang/Exception.h"
#include "java/lang/RuntimeException.h"

@interface MTAuthIdRetriever () {
}
@end

@interface MTAuthIdRetriever_$1 () {
 @public
  IOSBooleanArray *val$isFinished_;
  id<MTAuthIdRetriever_AuthIdCallback> val$callback_;
}
@end

J2OBJC_FIELD_SETTER(MTAuthIdRetriever_$1, val$isFinished_, IOSBooleanArray *)
J2OBJC_FIELD_SETTER(MTAuthIdRetriever_$1, val$callback_, id<MTAuthIdRetriever_AuthIdCallback>)

@interface MTAuthIdRetriever_$2 () {
 @public
  IOSBooleanArray *val$isFinished_;
  AMExponentialBackoff *val$backoff_;
  id<MTAuthIdRetriever_AuthIdCallback> val$callback_;
}
@end

J2OBJC_FIELD_SETTER(MTAuthIdRetriever_$2, val$isFinished_, IOSBooleanArray *)
J2OBJC_FIELD_SETTER(MTAuthIdRetriever_$2, val$backoff_, AMExponentialBackoff *)
J2OBJC_FIELD_SETTER(MTAuthIdRetriever_$2, val$callback_, id<MTAuthIdRetriever_AuthIdCallback>)


#line 17
@implementation MTAuthIdRetriever

NSString * MTAuthIdRetriever_TAG_ = @"AuthId";

+ (void)requestAuthIdWithAMEndpoints:(AMEndpoints *)endpoints
               withAMNetworkProvider:(id<AMNetworkProvider>)networkProvider
withMTAuthIdRetriever_AuthIdCallback:(id<MTAuthIdRetriever_AuthIdCallback>)callback {
  MTAuthIdRetriever_requestAuthIdWithAMEndpoints_withAMNetworkProvider_withMTAuthIdRetriever_AuthIdCallback_(endpoints, networkProvider, callback);
}

- (instancetype)init {
  return [super init];
}

@end

void MTAuthIdRetriever_requestAuthIdWithAMEndpoints_withAMNetworkProvider_withMTAuthIdRetriever_AuthIdCallback_(AMEndpoints *endpoints, id<AMNetworkProvider> networkProvider, id<MTAuthIdRetriever_AuthIdCallback> callback) {
  MTAuthIdRetriever_init();
  
#line 22
  AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_TAG_, @"Requesting AuthId");
  
#line 24
  IOSBooleanArray *isFinished = [IOSBooleanArray newArrayWithLength:1];
  AMExponentialBackoff *backoff = [[AMExponentialBackoff alloc] init];
  *IOSBooleanArray_GetRef(isFinished, 0) = NO;
  
#line 28
  [((id<AMNetworkProvider>) nil_chk(networkProvider)) createConnection:0 withMTProtoVersion:
#line 29
  AMActorApi_MTPROTO_VERSION withApiMajorVersion:
#line 30
  AMActorApi_API_MAJOR_VERSION withApiMinorVersion:
#line 31
  AMActorApi_API_MINOR_VERSION withEndpoint:
#line 32
  [((AMEndpoints *) nil_chk(endpoints)) fetchEndpoint] withCallback:[[MTAuthIdRetriever_$1 alloc] initWithBooleanArray:isFinished withMTAuthIdRetriever_AuthIdCallback:callback] withCreateCallback:
#line 86
  [[MTAuthIdRetriever_$2 alloc] initWithBooleanArray:isFinished withAMExponentialBackoff:backoff withMTAuthIdRetriever_AuthIdCallback:callback]];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(MTAuthIdRetriever)

J2OBJC_INTERFACE_TYPE_LITERAL_SOURCE(MTAuthIdRetriever_AuthIdCallback)

@implementation MTAuthIdRetriever_$1

- (void)onConnectionRedirect:(NSString *)host withPort:(jint)port withTimeout:(jint)timeout {
  
#line 36
  if (!IOSBooleanArray_Get(nil_chk(val$isFinished_), 0)) {
    *IOSBooleanArray_GetRef(val$isFinished_, 0) = YES;
    [((id<MTAuthIdRetriever_AuthIdCallback>) nil_chk(val$callback_)) onFailure];
    AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), @"Unable to create connection");
  }
}

- (void)onMessage:(IOSByteArray *)data withOffset:(jint)offset withLen:(jint)len {
  
#line 45
  if (IOSBooleanArray_Get(nil_chk(val$isFinished_), 0)) {
    return;
  }
  
#line 49
  @try {
    BSDataInput *dataInput = [[BSDataInput alloc] initWithByteArray:data withInt:offset withInt:len];
    jlong pAuthId = [dataInput readLong];
    jlong pSessionId = [dataInput readLong];
    jlong messageId = [dataInput readLong];
    IOSByteArray *payload = [dataInput readProtoBytes];
    
#line 56
    BSDataInput *msg = [[BSDataInput alloc] initWithByteArray:payload withInt:0 withInt:((IOSByteArray *) nil_chk(payload))->size_];
    jint header = [msg readByte];
    jlong authId = [msg readLong];
    
#line 60
    if (!IOSBooleanArray_Get(val$isFinished_, 0)) {
      *IOSBooleanArray_GetRef(val$isFinished_, 0) = YES;
      [((id<MTAuthIdRetriever_AuthIdCallback>) nil_chk(val$callback_)) onSuccessWithLong:authId];
      
#line 64
      AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), JreStrcat("$J", @"Auth Id loaded: ", authId));
      
#line 66
      return;
    }
  }
  @catch (
#line 68
  JavaLangException *e) {
    AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), @"Error during parsing auth id response");
    [((JavaLangException *) nil_chk(e)) printStackTrace];
  }
  
#line 74
  @throw [[JavaLangRuntimeException alloc] init];
}


#line 78
- (void)onConnectionDie {
  
#line 79
  if (!IOSBooleanArray_Get(nil_chk(val$isFinished_), 0)) {
    *IOSBooleanArray_GetRef(val$isFinished_, 0) = YES;
    [((id<MTAuthIdRetriever_AuthIdCallback>) nil_chk(val$callback_)) onFailure];
    
#line 83
    AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), @"Connection dies");
  }
}

- (instancetype)initWithBooleanArray:(IOSBooleanArray *)capture$0
withMTAuthIdRetriever_AuthIdCallback:(id<MTAuthIdRetriever_AuthIdCallback>)capture$1 {
  val$isFinished_ = capture$0;
  val$callback_ = capture$1;
  return [super init];
}

- (void)copyAllFieldsTo:(MTAuthIdRetriever_$1 *)other {
  [super copyAllFieldsTo:other];
  other->val$isFinished_ = val$isFinished_;
  other->val$callback_ = val$callback_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(MTAuthIdRetriever_$1)

@implementation MTAuthIdRetriever_$2

- (void)onConnectionCreated:(id<AMConnection>)connection {
  
#line 89
  if (IOSBooleanArray_Get(nil_chk(val$isFinished_), 0)) {
    return;
  }
  
#line 93
  AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), @"Connection created");
  [((AMExponentialBackoff *) nil_chk(val$backoff_)) onSuccess];
  
#line 96
  @try {
    BSDataOutput *output = [[BSDataOutput alloc] init];
    [output writeLongWithLong:0];
    [output writeLongWithLong:0];
    [output writeLongWithLong:0];
    [output writeVarIntWithLong:1];
    [output writeByteWithInt:(jint) 0xF0];
    IOSByteArray *data = [output toByteArray];
    [((id<AMConnection>) nil_chk(connection)) post:data withOffset:0 withLen:((IOSByteArray *) nil_chk(data))->size_];
  }
  @catch (
#line 105
  JavaLangException *e) {
    AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), @"Error during requesting auth id");
    [((JavaLangException *) nil_chk(e)) printStackTrace];
    if (!IOSBooleanArray_Get(val$isFinished_, 0)) {
      *IOSBooleanArray_GetRef(val$isFinished_, 0) = YES;
      [((id<MTAuthIdRetriever_AuthIdCallback>) nil_chk(val$callback_)) onFailure];
    }
  }
}


#line 116
- (void)onConnectionCreateError {
  
#line 117
  if (!IOSBooleanArray_Get(nil_chk(val$isFinished_), 0)) {
    *IOSBooleanArray_GetRef(val$isFinished_, 0) = YES;
    [((id<MTAuthIdRetriever_AuthIdCallback>) nil_chk(val$callback_)) onFailure];
    AMLog_dWithNSString_withNSString_(MTAuthIdRetriever_get_TAG_(), @"Unable to create connection");
  }
}

- (instancetype)initWithBooleanArray:(IOSBooleanArray *)capture$0
            withAMExponentialBackoff:(AMExponentialBackoff *)capture$1
withMTAuthIdRetriever_AuthIdCallback:(id<MTAuthIdRetriever_AuthIdCallback>)capture$2 {
  val$isFinished_ = capture$0;
  val$backoff_ = capture$1;
  val$callback_ = capture$2;
  return [super init];
}

- (void)copyAllFieldsTo:(MTAuthIdRetriever_$2 *)other {
  [super copyAllFieldsTo:other];
  other->val$isFinished_ = val$isFinished_;
  other->val$backoff_ = val$backoff_;
  other->val$callback_ = val$callback_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(MTAuthIdRetriever_$2)
