//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/messages/ConversationHistoryActor.java
//

#line 1 "/Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/messages/ConversationHistoryActor.java"

#include "J2ObjC_source.h"
#include "im/actor/model/api/OutPeer.h"
#include "im/actor/model/api/rpc/RequestLoadHistory.h"
#include "im/actor/model/api/rpc/ResponseLoadHistory.h"
#include "im/actor/model/droidkit/actors/Actor.h"
#include "im/actor/model/droidkit/actors/ActorRef.h"
#include "im/actor/model/droidkit/engine/PreferencesStorage.h"
#include "im/actor/model/entity/Peer.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/Updates.h"
#include "im/actor/model/modules/messages/ConversationHistoryActor.h"
#include "im/actor/model/modules/updates/internal/MessagesHistoryLoaded.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcException.h"
#include "java/lang/Long.h"

__attribute__((unused)) static void ImActorModelModulesMessagesConversationHistoryActor_onLoadMore(ImActorModelModulesMessagesConversationHistoryActor *self);
__attribute__((unused)) static void ImActorModelModulesMessagesConversationHistoryActor_onLoadedMoreWithInt_withLong_(ImActorModelModulesMessagesConversationHistoryActor *self, jint loaded, jlong maxLoadedDate);

@interface ImActorModelModulesMessagesConversationHistoryActor () {
 @public
  NSString *KEY_LOADED_DATE_;
  NSString *KEY_LOADED_;
  NSString *KEY_LOADED_INIT_;
  AMPeer *peer_;
  jlong historyMaxDate_;
  jboolean historyLoaded_;
  jboolean isLoading_;
}

- (void)onLoadMore;

- (void)onLoadedMoreWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate;
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesConversationHistoryActor, KEY_LOADED_DATE_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesConversationHistoryActor, KEY_LOADED_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesConversationHistoryActor, KEY_LOADED_INIT_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesConversationHistoryActor, peer_, AMPeer *)

@interface ImActorModelModulesMessagesConversationHistoryActor_LoadedMore () {
 @public
  jint loaded_;
  jlong maxLoadedDate_;
}
@end

@interface ImActorModelModulesMessagesConversationHistoryActor_$1 () {
 @public
  ImActorModelModulesMessagesConversationHistoryActor *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesConversationHistoryActor_$1, this$0_, ImActorModelModulesMessagesConversationHistoryActor *)


#line 15
@implementation ImActorModelModulesMessagesConversationHistoryActor


#line 29
- (instancetype)initWithAMPeer:(AMPeer *)peer
withImActorModelModulesModules:(ImActorModelModulesModules *)modules {
  if (self =
#line 30
  [super initWithImActorModelModulesModules:modules]) {
    isLoading_ =
#line 27
    NO;
    
#line 31
    self->peer_ = peer;
    
#line 32
    self->KEY_LOADED_DATE_ = JreStrcat("$@$", @"conv_", peer, @"_history_date");
    
#line 33
    self->KEY_LOADED_ = JreStrcat("$@$", @"conv_", peer, @"_history_loaded");
    
#line 34
    self->KEY_LOADED_INIT_ = JreStrcat("$@$", @"conv_", peer, @"_history_inited");
  }
  return self;
}


#line 38
- (void)preStart {
  
#line 39
  [super preStart];
  historyMaxDate_ = [((id<DKPreferencesStorage>) nil_chk([self preferences])) getLong:KEY_LOADED_DATE_ withDefault:JavaLangLong_MAX_VALUE];
  historyLoaded_ = [((id<DKPreferencesStorage>) nil_chk([self preferences])) getBool:KEY_LOADED_ withDefault:NO];
  if (![((id<DKPreferencesStorage>) nil_chk([self preferences])) getBool:KEY_LOADED_INIT_ withDefault:NO]) {
    [((DKActorRef *) nil_chk([self self__])) sendOnceWithId:[[ImActorModelModulesMessagesConversationHistoryActor_LoadMore alloc] init]];
  }
}


#line 47
- (void)onLoadMore {
  ImActorModelModulesMessagesConversationHistoryActor_onLoadMore(self);
}


#line 72
- (void)onLoadedMoreWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate {
  ImActorModelModulesMessagesConversationHistoryActor_onLoadedMoreWithInt_withLong_(self, loaded, maxLoadedDate);
}


#line 88
- (void)onReceiveWithId:(id)message {
  
#line 89
  if ([message isKindOfClass:[ImActorModelModulesMessagesConversationHistoryActor_LoadMore class]]) {
    ImActorModelModulesMessagesConversationHistoryActor_onLoadMore(self);
  }
  else
#line 91
  if ([message isKindOfClass:[ImActorModelModulesMessagesConversationHistoryActor_LoadedMore class]]) {
    ImActorModelModulesMessagesConversationHistoryActor_LoadedMore *loadedMore = (ImActorModelModulesMessagesConversationHistoryActor_LoadedMore *) check_class_cast(message, [ImActorModelModulesMessagesConversationHistoryActor_LoadedMore class]);
    ImActorModelModulesMessagesConversationHistoryActor_onLoadedMoreWithInt_withLong_(self, ((ImActorModelModulesMessagesConversationHistoryActor_LoadedMore *) nil_chk(loadedMore))->loaded_, loadedMore->maxLoadedDate_);
  }
  else {
    
#line 95
    [self dropWithId:message];
  }
}

- (void)copyAllFieldsTo:(ImActorModelModulesMessagesConversationHistoryActor *)other {
  [super copyAllFieldsTo:other];
  other->KEY_LOADED_DATE_ = KEY_LOADED_DATE_;
  other->KEY_LOADED_ = KEY_LOADED_;
  other->KEY_LOADED_INIT_ = KEY_LOADED_INIT_;
  other->peer_ = peer_;
  other->historyMaxDate_ = historyMaxDate_;
  other->historyLoaded_ = historyLoaded_;
  other->isLoading_ = isLoading_;
}

@end

void ImActorModelModulesMessagesConversationHistoryActor_onLoadMore(ImActorModelModulesMessagesConversationHistoryActor *self) {
  
#line 48
  if (self->historyLoaded_) {
    return;
  }
  if (self->isLoading_) {
    return;
  }
  self->isLoading_ = YES;
  
#line 56
  [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestLoadHistory alloc] initWithImActorModelApiOutPeer:[self buidOutPeerWithAMPeer:self->peer_] withLong:self->historyMaxDate_ withInt:ImActorModelModulesMessagesConversationHistoryActor_LIMIT] withAMRpcCallback:
#line 57
  [[ImActorModelModulesMessagesConversationHistoryActor_$1 alloc] initWithImActorModelModulesMessagesConversationHistoryActor:self]];
}

void ImActorModelModulesMessagesConversationHistoryActor_onLoadedMoreWithInt_withLong_(ImActorModelModulesMessagesConversationHistoryActor *self, jint loaded, jlong maxLoadedDate) {
  
#line 73
  self->isLoading_ = NO;
  
#line 75
  if (loaded < ImActorModelModulesMessagesConversationHistoryActor_LIMIT) {
    self->historyLoaded_ = YES;
  }
  else {
    
#line 78
    self->historyLoaded_ = NO;
    self->historyMaxDate_ = maxLoadedDate;
  }
  
#line 82
  [((id<DKPreferencesStorage>) nil_chk([self preferences])) putLong:self->KEY_LOADED_DATE_ withValue:maxLoadedDate];
  [((id<DKPreferencesStorage>) nil_chk([self preferences])) putBool:self->KEY_LOADED_ withValue:self->historyLoaded_];
  [((id<DKPreferencesStorage>) nil_chk([self preferences])) putBool:self->KEY_LOADED_INIT_ withValue:YES];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesConversationHistoryActor)


#line 99
@implementation ImActorModelModulesMessagesConversationHistoryActor_LoadMore

- (instancetype)init {
  return [super init];
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesConversationHistoryActor_LoadMore)


#line 103
@implementation ImActorModelModulesMessagesConversationHistoryActor_LoadedMore


#line 107
- (instancetype)initWithInt:(jint)loaded
                   withLong:(jlong)maxLoadedDate {
  if (self = [super init]) {
    
#line 108
    self->loaded_ = loaded;
    
#line 109
    self->maxLoadedDate_ = maxLoadedDate;
  }
  return self;
}

- (void)copyAllFieldsTo:(ImActorModelModulesMessagesConversationHistoryActor_LoadedMore *)other {
  [super copyAllFieldsTo:other];
  other->loaded_ = loaded_;
  other->maxLoadedDate_ = maxLoadedDate_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesConversationHistoryActor_LoadedMore)

@implementation ImActorModelModulesMessagesConversationHistoryActor_$1


#line 59
- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseLoadHistory *)response {
  
#line 61
  [((ImActorModelModulesUpdates *) nil_chk([this$0_ updates])) onUpdateReceivedWithId:[[ImActorModelModulesUpdatesInternalMessagesHistoryLoaded alloc] initWithAMPeer:this$0_->peer_ withImActorModelApiRpcResponseLoadHistory:response]];
}

- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  
#line 66
  [((AMRpcException *) nil_chk(e)) printStackTrace];
}

- (instancetype)initWithImActorModelModulesMessagesConversationHistoryActor:(ImActorModelModulesMessagesConversationHistoryActor *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesMessagesConversationHistoryActor_$1 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesConversationHistoryActor_$1)
