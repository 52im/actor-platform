//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/messages/MessageDeleteActor.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/api/OutPeer.h"
#include "im/actor/model/api/rpc/RequestDeleteMessage.h"
#include "im/actor/model/api/rpc/ResponseVoid.h"
#include "im/actor/model/droidkit/actors/Actor.h"
#include "im/actor/model/droidkit/engine/SyncKeyValue.h"
#include "im/actor/model/entity/Peer.h"
#include "im/actor/model/modules/Messages.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/messages/MessageDeleteActor.h"
#include "im/actor/model/modules/messages/entity/Delete.h"
#include "im/actor/model/modules/messages/entity/DeleteStorage.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcException.h"
#include "java/io/IOException.h"
#include "java/lang/Long.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/List.h"
#include "java/util/Set.h"

@interface ImActorModelModulesMessagesMessageDeleteActor () {
 @public
  DKSyncKeyValue *syncKeyValue_;
  ImActorModelModulesMessagesEntityDeleteStorage *deleteStorage_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor, syncKeyValue_, DKSyncKeyValue *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor, deleteStorage_, ImActorModelModulesMessagesEntityDeleteStorage *)

@interface ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage () {
 @public
  AMPeer *peer_;
  IOSLongArray *rids_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage, peer_, AMPeer *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage, rids_, IOSLongArray *)

@interface ImActorModelModulesMessagesMessageDeleteActor_$1 () {
 @public
  ImActorModelModulesMessagesMessageDeleteActor *this$0_;
  AMPeer *val$peer_;
  id<JavaUtilList> val$rids_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, this$0_, ImActorModelModulesMessagesMessageDeleteActor *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, val$peer_, AMPeer *)
J2OBJC_FIELD_SETTER(ImActorModelModulesMessagesMessageDeleteActor_$1, val$rids_, id<JavaUtilList>)

@implementation ImActorModelModulesMessagesMessageDeleteActor

- (instancetype)initWithImActorModelModulesModules:(ImActorModelModulesModules *)modules {
  if (self = [super initWithImActorModelModulesModules:modules]) {
    self->syncKeyValue_ = [((ImActorModelModulesMessages *) nil_chk([((ImActorModelModulesModules *) nil_chk(modules)) getMessagesModule])) getCursorStorage];
  }
  return self;
}

- (void)preStart {
  [super preStart];
  IOSByteArray *data = [((DKSyncKeyValue *) nil_chk(syncKeyValue_)) getWithLong:ImActorModelModulesUtilsModuleActor_CURSOR_DELETE];
  if (data != nil) {
    @try {
      deleteStorage_ = ImActorModelModulesMessagesEntityDeleteStorage_fromBytesWithByteArray_(data);
    }
    @catch (JavaIoIOException *e) {
      [((JavaIoIOException *) nil_chk(e)) printStackTrace];
      deleteStorage_ = [[ImActorModelModulesMessagesEntityDeleteStorage alloc] init];
    }
  }
  else {
    deleteStorage_ = [[ImActorModelModulesMessagesEntityDeleteStorage alloc] init];
  }
  for (AMPeer * __strong peer in nil_chk([((JavaUtilHashMap *) nil_chk([((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(deleteStorage_)) getPendingDeletions])) keySet])) {
    ImActorModelModulesMessagesEntityDelete *delete_ = [((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) getWithId:peer];
    if ([((id<JavaUtilList>) nil_chk([((ImActorModelModulesMessagesEntityDelete *) nil_chk(delete_)) getRids])) size] > 0) {
      [self performDeleteWithAMPeer:peer withJavaUtilList:[delete_ getRids]];
    }
  }
}

- (void)saveStorage {
  [((DKSyncKeyValue *) nil_chk(syncKeyValue_)) putWithLong:ImActorModelModulesUtilsModuleActor_CURSOR_DELETE withByteArray:[((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(deleteStorage_)) toByteArray]];
}

- (void)performDeleteWithAMPeer:(AMPeer *)peer
               withJavaUtilList:(id<JavaUtilList>)rids {
  ImActorModelApiOutPeer *outPeer = [self buidOutPeerWithAMPeer:peer];
  [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestDeleteMessage alloc] initWithImActorModelApiOutPeer:outPeer withJavaUtilList:rids] withAMRpcCallback:[[ImActorModelModulesMessagesMessageDeleteActor_$1 alloc] initWithImActorModelModulesMessagesMessageDeleteActor:self withAMPeer:peer withJavaUtilList:rids]];
}

- (void)onDeleteMessageWithAMPeer:(AMPeer *)peer
                 withJavaUtilList:(id<JavaUtilList>)rids {
  if (![((JavaUtilHashMap *) nil_chk([((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(deleteStorage_)) getPendingDeletions])) containsKeyWithId:peer]) {
    (void) [((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) putWithId:peer withId:[[ImActorModelModulesMessagesEntityDelete alloc] initWithAMPeer:peer withJavaUtilList:[[JavaUtilArrayList alloc] init]]];
  }
  [((id<JavaUtilList>) nil_chk([((ImActorModelModulesMessagesEntityDelete *) nil_chk([((JavaUtilHashMap *) nil_chk([deleteStorage_ getPendingDeletions])) getWithId:peer])) getRids])) addAllWithJavaUtilCollection:rids];
  [self saveStorage];
  [self performDeleteWithAMPeer:peer withJavaUtilList:rids];
}

- (void)onReceiveWithId:(id)message {
  if ([message isKindOfClass:[ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage class]]) {
    ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *deleteMessage = (ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *) check_class_cast(message, [ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage class]);
    JavaUtilArrayList *rids = [[JavaUtilArrayList alloc] init];
    {
      IOSLongArray *a__ = [((ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *) nil_chk(deleteMessage)) getRids];
      jlong const *b__ = ((IOSLongArray *) nil_chk(a__))->buffer_;
      jlong const *e__ = b__ + a__->size_;
      while (b__ < e__) {
        jlong l = *b__++;
        [rids addWithId:JavaLangLong_valueOfWithLong_(l)];
      }
    }
    [self onDeleteMessageWithAMPeer:[deleteMessage getPeer] withJavaUtilList:rids];
  }
  else {
    [self dropWithId:message];
  }
}

- (void)copyAllFieldsTo:(ImActorModelModulesMessagesMessageDeleteActor *)other {
  [super copyAllFieldsTo:other];
  other->syncKeyValue_ = syncKeyValue_;
  other->deleteStorage_ = deleteStorage_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesMessageDeleteActor)

@implementation ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage

- (instancetype)initWithAMPeer:(AMPeer *)peer
                 withLongArray:(IOSLongArray *)rids {
  if (self = [super init]) {
    self->peer_ = peer;
    self->rids_ = rids;
  }
  return self;
}

- (AMPeer *)getPeer {
  return peer_;
}

- (IOSLongArray *)getRids {
  return rids_;
}

- (void)copyAllFieldsTo:(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage *)other {
  [super copyAllFieldsTo:other];
  other->peer_ = peer_;
  other->rids_ = rids_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesMessageDeleteActor_DeleteMessage)

@implementation ImActorModelModulesMessagesMessageDeleteActor_$1

- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseVoid *)response {
  if ([((JavaUtilHashMap *) nil_chk([((ImActorModelModulesMessagesEntityDeleteStorage *) nil_chk(this$0_->deleteStorage_)) getPendingDeletions])) containsKeyWithId:val$peer_]) {
    [((id<JavaUtilList>) nil_chk([((ImActorModelModulesMessagesEntityDelete *) nil_chk([((JavaUtilHashMap *) nil_chk([this$0_->deleteStorage_ getPendingDeletions])) getWithId:val$peer_])) getRids])) removeAllWithJavaUtilCollection:val$rids_];
    [this$0_ saveStorage];
  }
}

- (void)onErrorWithAMRpcException:(AMRpcException *)e {
}

- (instancetype)initWithImActorModelModulesMessagesMessageDeleteActor:(ImActorModelModulesMessagesMessageDeleteActor *)outer$
                                                           withAMPeer:(AMPeer *)capture$0
                                                     withJavaUtilList:(id<JavaUtilList>)capture$1 {
  this$0_ = outer$;
  val$peer_ = capture$0;
  val$rids_ = capture$1;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesMessagesMessageDeleteActor_$1 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
  other->val$peer_ = val$peer_;
  other->val$rids_ = val$rids_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesMessagesMessageDeleteActor_$1)
