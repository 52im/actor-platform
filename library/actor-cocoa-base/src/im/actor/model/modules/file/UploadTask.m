//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/file/UploadTask.java
//

#line 1 "/Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/file/UploadTask.java"

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/Configuration.h"
#include "im/actor/model/FileSystemProvider.h"
#include "im/actor/model/api/FileLocation.h"
#include "im/actor/model/api/UploadConfig.h"
#include "im/actor/model/api/rpc/RequestCompleteUpload.h"
#include "im/actor/model/api/rpc/RequestStartUpload.h"
#include "im/actor/model/api/rpc/RequestUploadPart.h"
#include "im/actor/model/api/rpc/ResponseCompleteUpload.h"
#include "im/actor/model/api/rpc/ResponseStartUpload.h"
#include "im/actor/model/api/rpc/ResponseVoid.h"
#include "im/actor/model/droidkit/actors/ActorRef.h"
#include "im/actor/model/entity/FileReference.h"
#include "im/actor/model/files/FileSystemReference.h"
#include "im/actor/model/files/InputFile.h"
#include "im/actor/model/files/OutputFile.h"
#include "im/actor/model/log/Log.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/file/UploadManager.h"
#include "im/actor/model/modules/file/UploadTask.h"
#include "im/actor/model/modules/messages/entity/EntityConverter.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcException.h"
#include "im/actor/model/util/CRC32.h"

__attribute__((unused)) static void ImActorModelModulesFileUploadTask_startUpload(ImActorModelModulesFileUploadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileUploadTask_checkQueue(ImActorModelModulesFileUploadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileUploadTask_uploadPartWithInt_withInt_withByteArray_(ImActorModelModulesFileUploadTask *self, jint blockIndex, jint offset, IOSByteArray *data);
__attribute__((unused)) static void ImActorModelModulesFileUploadTask_reportError(ImActorModelModulesFileUploadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileUploadTask_reportProgressWithFloat_(ImActorModelModulesFileUploadTask *self, jfloat progress);
__attribute__((unused)) static void ImActorModelModulesFileUploadTask_reportCompleteWithAMFileReference_withAMFileSystemReference_(ImActorModelModulesFileUploadTask *self, AMFileReference *location, id<AMFileSystemReference> reference);

@interface ImActorModelModulesFileUploadTask () {
 @public
  NSString *TAG_;
  jboolean LOG_;
  jlong rid_;
  NSString *fileName_;
  NSString *descriptor_;
  id<AMFileSystemReference> srcReference_;
  id<AMInputFile> inputFile_;
  id<AMFileSystemReference> destReference_;
  id<AMOutputFile> outputFile_;
  DKActorRef *manager_;
  jboolean isCompleted_;
  jint blockSize_;
  jint blocksCount_;
  jint nextBlock_;
  jint uploaded_;
  jint uploadCount_;
  ImActorModelApiUploadConfig *uploadConfig_;
  AMCRC32 *crc32_;
}

- (void)startUpload;

- (void)checkQueue;

- (void)uploadPartWithInt:(jint)blockIndex
                  withInt:(jint)offset
            withByteArray:(IOSByteArray *)data;

- (void)reportError;

- (void)reportProgressWithFloat:(jfloat)progress;

- (void)reportCompleteWithAMFileReference:(AMFileReference *)location
                withAMFileSystemReference:(id<AMFileSystemReference>)reference;
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, TAG_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, fileName_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, descriptor_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, srcReference_, id<AMFileSystemReference>)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, inputFile_, id<AMInputFile>)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, destReference_, id<AMFileSystemReference>)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, outputFile_, id<AMOutputFile>)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, manager_, DKActorRef *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, uploadConfig_, ImActorModelApiUploadConfig *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask, crc32_, AMCRC32 *)

@interface ImActorModelModulesFileUploadTask_$1 () {
 @public
  ImActorModelModulesFileUploadTask *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask_$1, this$0_, ImActorModelModulesFileUploadTask *)

@interface ImActorModelModulesFileUploadTask_$2 () {
 @public
  ImActorModelModulesFileUploadTask *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask_$2, this$0_, ImActorModelModulesFileUploadTask *)

@interface ImActorModelModulesFileUploadTask_$3 () {
 @public
  ImActorModelModulesFileUploadTask *this$0_;
  jint val$blockIndex_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesFileUploadTask_$3, this$0_, ImActorModelModulesFileUploadTask *)


#line 26
@implementation ImActorModelModulesFileUploadTask


#line 55
- (instancetype)initWithLong:(jlong)rid
                withNSString:(NSString *)descriptor
                withNSString:(NSString *)fileName
              withDKActorRef:(DKActorRef *)manager
withImActorModelModulesModules:(ImActorModelModulesModules *)modules {
  if (self =
#line 56
  [super initWithImActorModelModulesModules:modules]) {
    isCompleted_ =
#line 44
    NO;
    blockSize_ =
#line 46
    8 * 1024;
    nextBlock_ =
#line 48
    0;
    
#line 57
    self->LOG_ = [((AMConfiguration *) nil_chk([((ImActorModelModulesModules *) nil_chk(modules)) getConfiguration])) isEnableFilesLogging];
    
#line 58
    self->rid_ = rid;
    
#line 59
    self->fileName_ = fileName;
    
#line 60
    self->descriptor_ = descriptor;
    
#line 61
    self->manager_ = manager;
    
#line 62
    self->TAG_ = JreStrcat("$JC", @"UploadTask{", rid, '}');
  }
  return self;
}


#line 66
- (void)preStart {
  
#line 67
  srcReference_ = [((id<AMFileSystemProvider>) nil_chk([((AMConfiguration *) nil_chk([self config])) getFileSystemProvider])) fileFromDescriptor:descriptor_];
  if (srcReference_ == nil) {
    if (LOG_) {
      AMLog_dWithNSString_withNSString_(TAG_, @"Error during file reference creating");
    }
    ImActorModelModulesFileUploadTask_reportError(self);
    return;
  }
  
#line 76
  destReference_ = [((id<AMFileSystemProvider>) nil_chk([((AMConfiguration *) nil_chk([self config])) getFileSystemProvider])) createTempFile];
  if (destReference_ == nil) {
    if (LOG_) {
      AMLog_dWithNSString_withNSString_(TAG_, @"Error during file dest reference creating");
    }
    ImActorModelModulesFileUploadTask_reportError(self);
    return;
  }
  
#line 85
  inputFile_ = [((id<AMFileSystemReference>) nil_chk(srcReference_)) openRead];
  if (inputFile_ == nil) {
    if (LOG_) {
      AMLog_dWithNSString_withNSString_(TAG_, @"Error during file open");
    }
    ImActorModelModulesFileUploadTask_reportError(self);
    return;
  }
  
#line 94
  outputFile_ = [((id<AMFileSystemReference>) nil_chk(destReference_)) openWriteWithSize:[srcReference_ getSize]];
  if (outputFile_ == nil) {
    [((id<AMInputFile>) nil_chk(inputFile_)) close];
    if (LOG_) {
      AMLog_dWithNSString_withNSString_(TAG_, @"Error during dest file open");
    }
    ImActorModelModulesFileUploadTask_reportError(self);
    return;
  }
  
#line 104
  crc32_ = [[AMCRC32 alloc] init];
  
#line 106
  ImActorModelModulesFileUploadTask_startUpload(self);
}


#line 109
- (void)startUpload {
  ImActorModelModulesFileUploadTask_startUpload(self);
}


#line 139
- (void)checkQueue {
  ImActorModelModulesFileUploadTask_checkQueue(self);
}


#line 223
- (void)uploadPartWithInt:(jint)blockIndex
                  withInt:(jint)offset
            withByteArray:(IOSByteArray *)data {
  ImActorModelModulesFileUploadTask_uploadPartWithInt_withInt_withByteArray_(self, blockIndex, offset, data);
}


#line 245
- (void)reportError {
  ImActorModelModulesFileUploadTask_reportError(self);
}


#line 253
- (void)reportProgressWithFloat:(jfloat)progress {
  ImActorModelModulesFileUploadTask_reportProgressWithFloat_(self, progress);
}


#line 260
- (void)reportCompleteWithAMFileReference:(AMFileReference *)location
                withAMFileSystemReference:(id<AMFileSystemReference>)reference {
  ImActorModelModulesFileUploadTask_reportCompleteWithAMFileReference_withAMFileSystemReference_(self, location, reference);
}

- (void)copyAllFieldsTo:(ImActorModelModulesFileUploadTask *)other {
  [super copyAllFieldsTo:other];
  other->TAG_ = TAG_;
  other->LOG_ = LOG_;
  other->rid_ = rid_;
  other->fileName_ = fileName_;
  other->descriptor_ = descriptor_;
  other->srcReference_ = srcReference_;
  other->inputFile_ = inputFile_;
  other->destReference_ = destReference_;
  other->outputFile_ = outputFile_;
  other->manager_ = manager_;
  other->isCompleted_ = isCompleted_;
  other->blockSize_ = blockSize_;
  other->blocksCount_ = blocksCount_;
  other->nextBlock_ = nextBlock_;
  other->uploaded_ = uploaded_;
  other->uploadCount_ = uploadCount_;
  other->uploadConfig_ = uploadConfig_;
  other->crc32_ = crc32_;
}

@end

void ImActorModelModulesFileUploadTask_startUpload(ImActorModelModulesFileUploadTask *self) {
  
#line 110
  self->blocksCount_ = [((id<AMFileSystemReference>) nil_chk(self->srcReference_)) getSize] / self->blockSize_;
  if ([self->srcReference_ getSize] % self->blockSize_ != 0) {
    self->blocksCount_++;
  }
  
#line 115
  if (self->LOG_) {
    AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$I$", @"Starting uploading ", self->blocksCount_, @" blocks"));
    AMLog_dWithNSString_withNSString_(self->TAG_, @"Requesting upload config...");
  }
  [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestStartUpload alloc] init] withAMRpcCallback:[[ImActorModelModulesFileUploadTask_$1 alloc] initWithImActorModelModulesFileUploadTask:self]];
}

void ImActorModelModulesFileUploadTask_checkQueue(ImActorModelModulesFileUploadTask *self) {
  
#line 140
  if (self->isCompleted_) {
    return;
  }
  
#line 144
  if (self->nextBlock_ == self->blocksCount_ && self->uploadCount_ == 0) {
    if (self->LOG_) {
      AMLog_dWithNSString_withNSString_(self->TAG_, @"Completing...");
    }
    jlong crc = [((AMCRC32 *) nil_chk(self->crc32_)) getValue];
    if (self->LOG_) {
      AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$J", @"Src #", crc));
      
#line 152
      AMLog_dWithNSString_withNSString_(self->TAG_, @"Closing files...");
    }
    [((id<AMInputFile>) nil_chk(self->inputFile_)) close];
    [((id<AMOutputFile>) nil_chk(self->outputFile_)) close];
    
#line 157
    [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestCompleteUpload alloc] initWithImActorModelApiUploadConfig:self->uploadConfig_ withInt:self->blocksCount_ withLong:crc] withAMRpcCallback:[[ImActorModelModulesFileUploadTask_$2 alloc] initWithImActorModelModulesFileUploadTask:self]];
    
#line 179
    return;
  }
  
#line 182
  if (self->nextBlock_ < self->blocksCount_ && self->uploadCount_ < ImActorModelModulesFileUploadTask_SIM_BLOCKS_COUNT) {
    jint blockIndex = self->nextBlock_++;
    
#line 185
    jint size = self->blockSize_;
    jint fileOffset = blockIndex * self->blockSize_;
    if ((blockIndex + 1) * self->blockSize_ > [((id<AMFileSystemReference>) nil_chk(self->srcReference_)) getSize]) {
      size = [self->srcReference_ getSize] - blockIndex * self->blockSize_;
    }
    IOSByteArray *data = [IOSByteArray newArrayWithLength:size];
    
#line 192
    if (![((id<AMInputFile>) nil_chk(self->inputFile_)) readAtOffset:fileOffset toArray:data withArrayOffset:0 withArrayLen:size]) {
      if (self->LOG_) {
        AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$I$", @"read #", blockIndex, @" error"));
      }
      ImActorModelModulesFileUploadTask_reportError(self);
      return;
    }
    if (![((id<AMOutputFile>) nil_chk(self->outputFile_)) writeWithOffset:fileOffset withData:data withDataOffset:0 withDataLen:size]) {
      if (self->LOG_) {
        AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$I$", @"write #", blockIndex, @" error"));
      }
      ImActorModelModulesFileUploadTask_reportError(self);
      return;
    }
    
#line 207
    [((AMCRC32 *) nil_chk(self->crc32_)) updateWithByteArray:data withInt:0 withInt:size];
    
#line 209
    if (self->LOG_) {
      AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$I", @"Starting block upload #", blockIndex));
    }
    
#line 213
    self->uploadCount_++;
    ImActorModelModulesFileUploadTask_uploadPartWithInt_withInt_withByteArray_(self, blockIndex, fileOffset, data);
    ImActorModelModulesFileUploadTask_checkQueue(self);
  }
  else {
    
#line 217
    if (self->LOG_) {
      AMLog_dWithNSString_withNSString_(self->TAG_, @"Nothing to do");
    }
  }
}

void ImActorModelModulesFileUploadTask_uploadPartWithInt_withInt_withByteArray_(ImActorModelModulesFileUploadTask *self, jint blockIndex, jint offset, IOSByteArray *data) {
  
#line 224
  [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestUploadPart alloc] initWithImActorModelApiUploadConfig:self->uploadConfig_ withInt:offset withByteArray:data] withAMRpcCallback:[[ImActorModelModulesFileUploadTask_$3 alloc] initWithImActorModelModulesFileUploadTask:self withInt:blockIndex]];
}

void ImActorModelModulesFileUploadTask_reportError(ImActorModelModulesFileUploadTask *self) {
  
#line 246
  if (self->isCompleted_) {
    return;
  }
  self->isCompleted_ = YES;
  [((DKActorRef *) nil_chk(self->manager_)) sendWithId:[[ImActorModelModulesFileUploadManager_UploadTaskError alloc] initWithLong:self->rid_]];
}

void ImActorModelModulesFileUploadTask_reportProgressWithFloat_(ImActorModelModulesFileUploadTask *self, jfloat progress) {
  
#line 254
  if (self->isCompleted_) {
    return;
  }
  [((DKActorRef *) nil_chk(self->manager_)) sendWithId:[[ImActorModelModulesFileUploadManager_UploadTaskProgress alloc] initWithLong:self->rid_ withFloat:progress]];
}

void ImActorModelModulesFileUploadTask_reportCompleteWithAMFileReference_withAMFileSystemReference_(ImActorModelModulesFileUploadTask *self, AMFileReference *location, id<AMFileSystemReference> reference) {
  
#line 261
  if (self->isCompleted_) {
    return;
  }
  self->isCompleted_ = YES;
  [((DKActorRef *) nil_chk(self->manager_)) sendWithId:[[ImActorModelModulesFileUploadManager_UploadTaskComplete alloc] initWithLong:self->rid_ withAMFileReference:location withAMFileSystemReference:reference]];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesFileUploadTask)

@implementation ImActorModelModulesFileUploadTask_$1


#line 121
- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseStartUpload *)response {
  
#line 122
  if (this$0_->LOG_) {
    AMLog_dWithNSString_withNSString_(this$0_->TAG_, @"Upload config loaded");
  }
  this$0_->uploadConfig_ = [((ImActorModelApiRpcResponseStartUpload *) nil_chk(response)) getConfig];
  ImActorModelModulesFileUploadTask_checkQueue(this$0_);
}


#line 130
- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  if (this$0_->LOG_) {
    AMLog_dWithNSString_withNSString_(this$0_->TAG_, @"Upload config load error");
  }
  ImActorModelModulesFileUploadTask_reportError(this$0_);
}

- (instancetype)initWithImActorModelModulesFileUploadTask:(ImActorModelModulesFileUploadTask *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesFileUploadTask_$1 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesFileUploadTask_$1)

@implementation ImActorModelModulesFileUploadTask_$2


#line 159
- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseCompleteUpload *)response {
  
#line 160
  if (this$0_->LOG_) {
    AMLog_dWithNSString_withNSString_(this$0_->TAG_, @"Upload completed...");
  }
  
#line 164
  AMFileReference *location = ImActorModelModulesMessagesEntityEntityConverter_convertWithImActorModelApiFileLocation_withNSString_withInt_([((ImActorModelApiRpcResponseCompleteUpload *) nil_chk(response)) getLocation], this$0_->fileName_, [((id<AMFileSystemReference>) nil_chk(this$0_->srcReference_)) getSize]);
  
#line 166
  id<AMFileSystemReference> reference = [((id<AMFileSystemProvider>) nil_chk([((AMConfiguration *) nil_chk([this$0_ config])) getFileSystemProvider])) commitTempFile:this$0_->destReference_ withReference:location];
  
#line 168
  ImActorModelModulesFileUploadTask_reportCompleteWithAMFileReference_withAMFileSystemReference_(this$0_, location, reference);
}


#line 172
- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  
#line 173
  if (this$0_->LOG_) {
    AMLog_dWithNSString_withNSString_(this$0_->TAG_, @"Upload complete error");
  }
  ImActorModelModulesFileUploadTask_reportError(this$0_);
}

- (instancetype)initWithImActorModelModulesFileUploadTask:(ImActorModelModulesFileUploadTask *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesFileUploadTask_$2 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesFileUploadTask_$2)

@implementation ImActorModelModulesFileUploadTask_$3


#line 226
- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseVoid *)response {
  
#line 227
  if (this$0_->LOG_) {
    AMLog_dWithNSString_withNSString_(this$0_->TAG_, JreStrcat("$I$", @"Block #", val$blockIndex_, @" uploaded"));
  }
  this$0_->uploadCount_--;
  this$0_->uploaded_++;
  
#line 233
  ImActorModelModulesFileUploadTask_reportProgressWithFloat_(this$0_, this$0_->uploaded_ / (jfloat) this$0_->blocksCount_);
  
#line 235
  ImActorModelModulesFileUploadTask_checkQueue(this$0_);
}


#line 239
- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  
#line 240
  ImActorModelModulesFileUploadTask_reportError(this$0_);
}

- (instancetype)initWithImActorModelModulesFileUploadTask:(ImActorModelModulesFileUploadTask *)outer$
                                                  withInt:(jint)capture$0 {
  this$0_ = outer$;
  val$blockIndex_ = capture$0;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesFileUploadTask_$3 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
  other->val$blockIndex_ = val$blockIndex_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesFileUploadTask_$3)
