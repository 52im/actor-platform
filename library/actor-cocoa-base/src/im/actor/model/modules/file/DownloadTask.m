//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/file/DownloadTask.java
//

#line 1 "/Users/ex3ndr/Develop/actor-model/library/actor-cocoa-base/build/java/im/actor/model/modules/file/DownloadTask.java"

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "im/actor/model/Configuration.h"
#include "im/actor/model/FileSystemProvider.h"
#include "im/actor/model/api/FileLocation.h"
#include "im/actor/model/api/rpc/RequestGetFile.h"
#include "im/actor/model/api/rpc/ResponseGetFile.h"
#include "im/actor/model/droidkit/actors/ActorRef.h"
#include "im/actor/model/entity/FileReference.h"
#include "im/actor/model/files/FileSystemReference.h"
#include "im/actor/model/files/OutputFile.h"
#include "im/actor/model/log/Log.h"
#include "im/actor/model/modules/Modules.h"
#include "im/actor/model/modules/file/DownloadManager.h"
#include "im/actor/model/modules/file/DownloadTask.h"
#include "im/actor/model/modules/utils/ModuleActor.h"
#include "im/actor/model/network/RpcException.h"

__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_startDownload(ImActorModelModulesFileDownloadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_completeDownload(ImActorModelModulesFileDownloadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_checkQueue(ImActorModelModulesFileDownloadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_downloadPartWithInt_withInt_(ImActorModelModulesFileDownloadTask *self, jint blockIndex, jint fileOffset);
__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_reportError(ImActorModelModulesFileDownloadTask *self);
__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_reportProgressWithFloat_(ImActorModelModulesFileDownloadTask *self, jfloat progress);
__attribute__((unused)) static void ImActorModelModulesFileDownloadTask_reportCompleteWithAMFileSystemReference_(ImActorModelModulesFileDownloadTask *self, id<AMFileSystemReference> reference);

@interface ImActorModelModulesFileDownloadTask () {
 @public
  NSString *TAG_;
  AMFileReference *fileReference_;
  DKActorRef *manager_;
  id<AMFileSystemProvider> fileSystemProvider_;
  id<AMFileSystemReference> destReference_;
  id<AMOutputFile> outputFile_;
  jboolean isCompleted_;
  jint blockSize_;
  jint blocksCount_;
  jint nextBlock_;
  jint currentDownloads_;
  jint downloaded_;
}

- (void)startDownload;

- (void)completeDownload;

- (void)checkQueue;

- (void)downloadPartWithInt:(jint)blockIndex
                    withInt:(jint)fileOffset;

- (void)reportError;

- (void)reportProgressWithFloat:(jfloat)progress;

- (void)reportCompleteWithAMFileSystemReference:(id<AMFileSystemReference>)reference;
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask, TAG_, NSString *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask, fileReference_, AMFileReference *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask, manager_, DKActorRef *)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask, fileSystemProvider_, id<AMFileSystemProvider>)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask, destReference_, id<AMFileSystemReference>)
J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask, outputFile_, id<AMOutputFile>)

@interface ImActorModelModulesFileDownloadTask_$1 () {
 @public
  ImActorModelModulesFileDownloadTask *this$0_;
  jint val$blockIndex_;
  jint val$fileOffset_;
}
@end

J2OBJC_FIELD_SETTER(ImActorModelModulesFileDownloadTask_$1, this$0_, ImActorModelModulesFileDownloadTask *)


#line 19
@implementation ImActorModelModulesFileDownloadTask


#line 40
- (instancetype)initWithAMFileReference:(AMFileReference *)fileReference
                         withDKActorRef:(DKActorRef *)manager
         withImActorModelModulesModules:(ImActorModelModulesModules *)messenger {
  if (self =
#line 41
  [super initWithImActorModelModulesModules:messenger]) {
    blockSize_ =
#line 34
    8 * 1024;
    nextBlock_ =
#line 36
    0;
    currentDownloads_ =
#line 37
    0;
    downloaded_ =
#line 38
    0;
    
#line 42
    self->TAG_ = JreStrcat("$JC", @"DownloadTask{", [((AMFileReference *) nil_chk(fileReference)) getFileId], '}');
    
#line 43
    self->fileReference_ = fileReference;
    
#line 44
    self->manager_ = manager;
  }
  return self;
}


#line 48
- (void)preStart {
  
#line 50
  AMLog_dWithNSString_withNSString_(TAG_, @"Creating file...");
  
#line 52
  fileSystemProvider_ = [((AMConfiguration *) nil_chk([((ImActorModelModulesModules *) nil_chk([self modules])) getConfiguration])) getFileSystemProvider];
  if (fileSystemProvider_ == nil) {
    ImActorModelModulesFileDownloadTask_reportError(self);
    AMLog_dWithNSString_withNSString_(TAG_, @"No FileSystem available");
    return;
  }
  
#line 59
  destReference_ = [((id<AMFileSystemProvider>) nil_chk(fileSystemProvider_)) createTempFile];
  if (destReference_ == nil) {
    ImActorModelModulesFileDownloadTask_reportError(self);
    AMLog_dWithNSString_withNSString_(TAG_, @"Unable to create reference");
    return;
  }
  
#line 66
  outputFile_ = [((id<AMFileSystemReference>) nil_chk(destReference_)) openWriteWithSize:[((AMFileReference *) nil_chk(fileReference_)) getFileSize]];
  if (outputFile_ == nil) {
    ImActorModelModulesFileDownloadTask_reportError(self);
    AMLog_dWithNSString_withNSString_(TAG_, @"Unable to write wile");
    return;
  }
  
#line 73
  ImActorModelModulesFileDownloadTask_startDownload(self);
}


#line 76
- (void)startDownload {
  ImActorModelModulesFileDownloadTask_startDownload(self);
}


#line 86
- (void)completeDownload {
  ImActorModelModulesFileDownloadTask_completeDownload(self);
}


#line 107
- (void)checkQueue {
  ImActorModelModulesFileDownloadTask_checkQueue(self);
}


#line 130
- (void)downloadPartWithInt:(jint)blockIndex
                    withInt:(jint)fileOffset {
  ImActorModelModulesFileDownloadTask_downloadPartWithInt_withInt_(self, blockIndex, fileOffset);
}


#line 155
- (void)reportError {
  ImActorModelModulesFileDownloadTask_reportError(self);
}


#line 163
- (void)reportProgressWithFloat:(jfloat)progress {
  ImActorModelModulesFileDownloadTask_reportProgressWithFloat_(self, progress);
}


#line 170
- (void)reportCompleteWithAMFileSystemReference:(id<AMFileSystemReference>)reference {
  ImActorModelModulesFileDownloadTask_reportCompleteWithAMFileSystemReference_(self, reference);
}

- (void)copyAllFieldsTo:(ImActorModelModulesFileDownloadTask *)other {
  [super copyAllFieldsTo:other];
  other->TAG_ = TAG_;
  other->fileReference_ = fileReference_;
  other->manager_ = manager_;
  other->fileSystemProvider_ = fileSystemProvider_;
  other->destReference_ = destReference_;
  other->outputFile_ = outputFile_;
  other->isCompleted_ = isCompleted_;
  other->blockSize_ = blockSize_;
  other->blocksCount_ = blocksCount_;
  other->nextBlock_ = nextBlock_;
  other->currentDownloads_ = currentDownloads_;
  other->downloaded_ = downloaded_;
}

@end

void ImActorModelModulesFileDownloadTask_startDownload(ImActorModelModulesFileDownloadTask *self) {
  
#line 77
  self->blocksCount_ = [((AMFileReference *) nil_chk(self->fileReference_)) getFileSize] / self->blockSize_;
  if ([self->fileReference_ getFileSize] % self->blockSize_ != 0) {
    self->blocksCount_++;
  }
  
#line 82
  AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$I$", @"Starting downloading ", self->blocksCount_, @" blocks"));
  ImActorModelModulesFileDownloadTask_checkQueue(self);
}

void ImActorModelModulesFileDownloadTask_completeDownload(ImActorModelModulesFileDownloadTask *self) {
  
#line 87
  if (self->isCompleted_) {
    return;
  }
  
#line 91
  AMLog_dWithNSString_withNSString_(self->TAG_, @"Closing file...");
  if (![((id<AMOutputFile>) nil_chk(self->outputFile_)) close]) {
    ImActorModelModulesFileDownloadTask_reportError(self);
    return;
  }
  
#line 97
  id<AMFileSystemReference> reference = [((id<AMFileSystemProvider>) nil_chk(self->fileSystemProvider_)) commitTempFile:self->destReference_ withReference:self->fileReference_];
  if (reference == nil) {
    ImActorModelModulesFileDownloadTask_reportError(self);
    return;
  }
  
#line 103
  AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$$C", @"Complete download {", [((id<AMFileSystemReference>) nil_chk(reference)) getDescriptor], '}'));
  ImActorModelModulesFileDownloadTask_reportCompleteWithAMFileSystemReference_(self, reference);
}

void ImActorModelModulesFileDownloadTask_checkQueue(ImActorModelModulesFileDownloadTask *self) {
  
#line 108
  if (self->isCompleted_) {
    return;
  }
  
#line 112
  AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$ICI", @"checkQueue ", self->currentDownloads_, '/', self->nextBlock_));
  if (self->currentDownloads_ == 0 && self->nextBlock_ >= self->blocksCount_) {
    ImActorModelModulesFileDownloadTask_completeDownload(self);
  }
  else
#line 115
  if (self->currentDownloads_ < ImActorModelModulesFileDownloadTask_SIM_BLOCKS_COUNT && self->nextBlock_ < self->blocksCount_) {
    self->currentDownloads_++;
    jint blockIndex = self->nextBlock_++;
    jint offset = blockIndex * self->blockSize_;
    
#line 120
    AMLog_dWithNSString_withNSString_(self->TAG_, JreStrcat("$I$", @"Starting part #", blockIndex, @" download"));
    
#line 122
    ImActorModelModulesFileDownloadTask_downloadPartWithInt_withInt_(self, blockIndex, offset);
    
#line 124
    ImActorModelModulesFileDownloadTask_checkQueue(self);
  }
  else {
    
#line 126
    AMLog_dWithNSString_withNSString_(self->TAG_, @"Task queue is full");
  }
}

void ImActorModelModulesFileDownloadTask_downloadPartWithInt_withInt_(ImActorModelModulesFileDownloadTask *self, jint blockIndex, jint fileOffset) {
  
#line 131
  [self requestWithImActorModelNetworkParserRequest:[[ImActorModelApiRpcRequestGetFile alloc] initWithImActorModelApiFileLocation:[[ImActorModelApiFileLocation alloc] initWithLong:[((AMFileReference *) nil_chk(self->fileReference_)) getFileId] withLong:
#line 132
  [self->fileReference_ getAccessHash]] withInt:fileOffset withInt:self->blockSize_] withAMRpcCallback:[[ImActorModelModulesFileDownloadTask_$1 alloc] initWithImActorModelModulesFileDownloadTask:self withInt:blockIndex withInt:fileOffset]];
}

void ImActorModelModulesFileDownloadTask_reportError(ImActorModelModulesFileDownloadTask *self) {
  
#line 156
  if (self->isCompleted_) {
    return;
  }
  self->isCompleted_ = YES;
  [((DKActorRef *) nil_chk(self->manager_)) sendWithId:[[ImActorModelModulesFileDownloadManager_OnDownloadedError alloc] initWithLong:[((AMFileReference *) nil_chk(self->fileReference_)) getFileId]]];
}

void ImActorModelModulesFileDownloadTask_reportProgressWithFloat_(ImActorModelModulesFileDownloadTask *self, jfloat progress) {
  
#line 164
  if (self->isCompleted_) {
    return;
  }
  [((DKActorRef *) nil_chk(self->manager_)) sendWithId:[[ImActorModelModulesFileDownloadManager_OnDownloadProgress alloc] initWithLong:[((AMFileReference *) nil_chk(self->fileReference_)) getFileId] withFloat:progress]];
}

void ImActorModelModulesFileDownloadTask_reportCompleteWithAMFileSystemReference_(ImActorModelModulesFileDownloadTask *self, id<AMFileSystemReference> reference) {
  
#line 171
  if (self->isCompleted_) {
    return;
  }
  self->isCompleted_ = YES;
  [((DKActorRef *) nil_chk(self->manager_)) sendWithId:[[ImActorModelModulesFileDownloadManager_OnDownloaded alloc] initWithLong:[((AMFileReference *) nil_chk(self->fileReference_)) getFileId] withAMFileSystemReference:reference]];
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesFileDownloadTask)

@implementation ImActorModelModulesFileDownloadTask_$1


#line 134
- (void)onResultWithImActorModelNetworkParserResponse:(ImActorModelApiRpcResponseGetFile *)response {
  
#line 135
  this$0_->downloaded_++;
  AMLog_dWithNSString_withNSString_(this$0_->TAG_, JreStrcat("$I$", @"Download part #", val$blockIndex_, @" completed"));
  if (![((id<AMOutputFile>) nil_chk(this$0_->outputFile_)) writeWithOffset:val$fileOffset_ withData:[((ImActorModelApiRpcResponseGetFile *) nil_chk(response)) getPayload] withDataOffset:0 withDataLen:((IOSByteArray *) nil_chk(
#line 138
  [response getPayload]))->size_]) {
    ImActorModelModulesFileDownloadTask_reportError(this$0_);
    return;
  }
  this$0_->currentDownloads_--;
  ImActorModelModulesFileDownloadTask_reportProgressWithFloat_(this$0_, this$0_->downloaded_ / (jfloat) this$0_->blocksCount_);
  ImActorModelModulesFileDownloadTask_checkQueue(this$0_);
}


#line 148
- (void)onErrorWithAMRpcException:(AMRpcException *)e {
  
#line 149
  AMLog_dWithNSString_withNSString_(this$0_->TAG_, JreStrcat("$I$", @"Download part #", val$blockIndex_, @" failure"));
  ImActorModelModulesFileDownloadTask_reportError(this$0_);
}

- (instancetype)initWithImActorModelModulesFileDownloadTask:(ImActorModelModulesFileDownloadTask *)outer$
                                                    withInt:(jint)capture$0
                                                    withInt:(jint)capture$1 {
  this$0_ = outer$;
  val$blockIndex_ = capture$0;
  val$fileOffset_ = capture$1;
  return [super init];
}

- (void)copyAllFieldsTo:(ImActorModelModulesFileDownloadTask_$1 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
  other->val$blockIndex_ = val$blockIndex_;
  other->val$fileOffset_ = val$fileOffset_;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ImActorModelModulesFileDownloadTask_$1)
